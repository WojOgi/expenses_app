<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Expense Tracker</title>
    <!-- Chart.js is loaded from a CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      /* Updated Lighter Dark Theme */
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #2c2c2c; /* lighter dark gray */
        color: #f0f0f0;
      }
      h1 {
        text-align: center;
      }
      form,
      .charts-section,
      table,
      .data-section {
        background-color: #3a3a3a; /* slightly lighter panels */
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        margin-bottom: 20px;
      }
      input,
      select,
      button {
        background-color: #555;
        border: none;
        padding: 8px;
        color: #f0f0f0;
        border-radius: 4px;
        margin-right: 5px;
        margin-bottom: 5px;
      }
      input:focus,
      select:focus {
        outline: none;
        border: 1px solid #777;
      }
      button:hover {
        background-color: #666;
        cursor: pointer;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }
      th,
      td {
        border: 1px solid #777;
        padding: 10px;
        text-align: left;
      }
      th {
        background-color: #555;
      }
      th.sortable {
        cursor: pointer;
      }
      .remove-btn,
      .edit-btn,
      .add-cat-btn {
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 5px;
      }
      .remove-btn {
        background-color: #cc0000;
        color: #fff;
      }
      .remove-btn:hover {
        background-color: #ff3333;
      }
      .edit-btn {
        background-color: #0066cc;
        color: #fff;
      }
      .edit-btn:hover {
        background-color: #3399ff;
      }
      .add-cat-btn {
        background-color: #228b22;
        color: #fff;
      }
      .add-cat-btn:hover {
        background-color: #32cd32;
      }
      /* Container for new category input */
      #new-category-container {
        margin-top: 10px;
      }
      /* Filter categories container */
      #filter-category-container {
        margin-top: 5px;
      }
      /* Exchange rates section */
      #exchange-rates {
        background-color: #3a3a3a;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        font-size: 0.9em;
        flex: 1;
      }
      /* Currency Calculator styles */
      #currency-calculator {
        background-color: #3a3a3a;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        font-size: 0.9em;
        flex: 1;
      }
      /* Save/Load Data styles */
      #save-load {
        background-color: #3a3a3a;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        font-size: 0.9em;
        flex: 1;
      }
      /* Advanced Filter styles */
      #advanced-filter {
        background-color: #3a3a3a;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        font-size: 0.9em;
        flex: 1;
        display: none; /* Collapsed by default */
      }
      /* Flex containers for top sections */
      #top-header,
      #top-controls {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
      }
      /* Statistics text container arranged in 3 columns */
      #stats-text {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
      }
      #stats-text > div {
        flex: 1;
        padding: 10px;
        border: 1px solid #777;
        border-radius: 8px;
      }
      /* Flex layout for charts */
      #charts-container {
        display: flex;
        gap: 20px;
        margin-top: 20px;
      }
      #bar-chart-section,
      #pie-charts-section {
        flex: 1;
      }
      #pie-charts-section > div {
        margin-bottom: 20px;
      }
      /* Reduce pie chart canvas size */
      #pie-charts-section canvas {
        width: 300px !important;
        height: 300px !important;
      }
      /* Statistics section canvas styles */
      #stats-charts {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        margin-top: 20px;
      }
      #stats-charts > div {
        flex: 1;
        min-width: 300px;
      }
      /* Expenses table container for collapsible functionality */
      #expenses-table-container {
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <h1>Expense Tracker</h1>

    <!-- Top Header: Exchange Rates and Expense Input Form side by side -->
    <div id="top-header">
      <!-- Exchange Rates Section with tooltip -->
      <div
        id="exchange-rates"
        title="These exchange rates are in relation to SAR. For example, 1 USD = X SAR."
      >
        Loading exchange rates...
      </div>
      <!-- Expense Input Form with tooltip -->
      <div style="flex: 1">
        <form
          id="expense-form"
          title="Enter your expense details here. You can also add a new custom category using the field below."
        >
          <!-- Hidden field to store index when editing -->
          <input type="hidden" id="expense-index" />
          <label
            >Date:
            <input type="date" id="expense-date" required />
          </label>
          <label
            >Category:
            <select id="expense-category" required></select>
          </label>
          <label
            >Description:
            <input
              type="text"
              id="expense-description"
              placeholder="Optional"
            />
          </label>
          <label
            >Amount:
            <input type="number" id="expense-amount" step="0.01" required />
          </label>
          <button type="submit" id="submit-btn">Add Expense</button>
          <div id="new-category-container">
            <label
              >New Category:
              <input
                type="text"
                id="new-category"
                placeholder="Enter new category"
              />
              <button type="button" id="add-category-btn" class="add-cat-btn">
                Add Category
              </button>
            </label>
          </div>
        </form>
      </div>
    </div>

    <!-- Top Controls: Currency Calculator, Save/Load Data, and Advanced Filter arranged horizontally -->
    <div id="top-controls">
      <!-- Currency Calculator Tool -->
      <div
        id="currency-calculator"
        title="Convert an amount from USD, EUR, or PLN to SAR using current exchange rates."
      >
        <h3>Currency Calculator</h3>
        <label for="calc-amount">Amount:</label>
        <input type="number" id="calc-amount" step="0.01" />
        <label for="calc-currency">Currency:</label>
        <select id="calc-currency">
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
          <option value="PLN">PLN</option>
        </select>
        <button type="button" id="calc-btn">Convert to SAR</button>
        <span id="calc-result"></span>
      </div>
      <!-- Save / Load Data Section -->
      <div
        id="save-load"
        title="Save your expenses and custom categories to a file or load them from a file."
      >
        <h2>Save / Load Data</h2>
        <p style="font-size: 0.9em; color: #ccc">
          Save your expense data (including custom categories) or load existing
          data.
        </p>
        <button id="save-btn">Save to File</button>
        <input type="file" id="load-file" accept=".txt,.json" />
      </div>
      <!-- Advanced Filter Section (collapsible) -->
      <div
        id="advanced-filter"
        title="Use these filters to narrow down your expense records by date, category, or amount."
      >
        <h2>Advanced Filter</h2>
        <form id="filter-form">
          <label
            >From Date:
            <input type="date" id="filter-from-date" />
          </label>
          <label
            >To Date:
            <input type="date" id="filter-to-date" />
          </label>
          <br />
          <label>Categories: </label>
          <div id="filter-category-container"></div>
          <br />
          <label
            >Min Amount:
            <input type="number" id="filter-min-amount" step="0.01" />
          </label>
          <label
            >Max Amount:
            <input type="number" id="filter-max-amount" step="0.01" />
          </label>
          <br />
          <button type="submit">Apply Filter</button>
          <button type="button" id="clear-filter-btn">Clear Filter</button>
        </form>
      </div>
    </div>

    <!-- Button to toggle Advanced Filter -->
    <div style="text-align: center; margin-bottom: 20px">
      <button
        id="toggle-filter-btn"
        title="Click to show or hide the advanced filter options."
      >
        Show Advanced Filter
      </button>
    </div>

    <!-- Statistics Section with horizontal text columns and charts below -->
    <div
      id="stats-section"
      class="data-section"
      title="View statistics about your expenses including totals, averages, and projections."
    >
      <h2>Statistics</h2>
      <!-- Statistics text arranged in three horizontal columns -->
      <div id="stats-container"></div>
      <!-- Container for statistics charts arranged horizontally -->
      <div id="stats-charts">
        <div>
          <canvas id="monthly-chart"></canvas>
        </div>
        <div>
          <canvas id="category-chart"></canvas>
        </div>
        <div>
          <canvas id="monthly-avg-chart"></canvas>
        </div>
      </div>
    </div>

    <!-- Analyze Button with tooltip -->
    <button
      id="analyze-btn"
      title="Click here to generate charts and visualizations of your expense data."
    >
      Analyze
    </button>

    <!-- Charts Container for Expense Analysis with tooltip -->
    <div
      id="charts-container"
      style="display: none"
      title="These charts provide visual insights into your expenses over time."
    >
      <!-- Bar Chart Section -->
      <div id="bar-chart-section">
        <canvas id="expense-chart"></canvas>
      </div>
      <!-- Pie Charts Section -->
      <div id="pie-charts-section">
        <!-- Pie charts for each month will be dynamically generated here -->
      </div>
    </div>

    <!-- Button to toggle Expenses Table (placed below charts) -->
    <div style="text-align: center; margin-bottom: 20px">
      <button
        id="toggle-expenses-btn"
        title="Click to show or hide the expenses table."
      >
        Hide Expenses
      </button>
    </div>

    <!-- Expenses Table (collapsible) -->
    <div
      class="data-section"
      title="This table displays all your expenses. Click on the column headers to sort the data."
      id="expenses-table-container"
    >
      <h2>Expenses</h2>
      <table id="expense-table">
        <thead>
          <tr>
            <th class="sortable" data-sort="date">Date</th>
            <th class="sortable" data-sort="date">Month</th>
            <th class="sortable" data-sort="category">Category</th>
            <th class="sortable" data-sort="description">Description</th>
            <th class="sortable" data-sort="amount">Amount</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <!-- Filtered expense rows will be inserted here -->
        </tbody>
      </table>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Helper function to format amounts (rounded to nearest integer with comma separators)
        function formatAmount(value) {
          return Math.round(value).toLocaleString("en-US");
        }

        // Global expenses array and chart variables
        let expenses = [];
        let expenseChart = null;
        let monthlyChart = null;
        let categoryChart = null;
        let monthlyAvgChart = null;

        // Default and custom categories
        const defaultCategories = [
          "Meals",
          "Groceries",
          "Car",
          "ATM",
          "Education",
          "Entertainment",
          "Travel",
          "Nanny Salary",
          "Other",
        ];
        let customCategories = [];

        // Fixed color mapping for default categories
        const categoryColors = {
          Meals: "rgba(255, 99, 132, 0.5)",
          Groceries: "rgba(54, 162, 235, 0.5)",
          Car: "rgba(255, 206, 86, 0.5)",
          ATM: "rgba(75, 192, 192, 0.5)",
          Education: "rgba(153, 102, 255, 0.5)",
          Entertainment: "rgba(255, 159, 64, 0.5)",
          Travel: "rgba(0, 200, 150, 0.5)",
          "Nanny Salary": "rgba(100, 149, 237, 0.5)",
          Other: "rgba(201, 203, 207, 0.5)",
        };
        const categoryBorderColors = {
          Meals: "rgba(255, 99, 132, 1)",
          Groceries: "rgba(54, 162, 235, 1)",
          Car: "rgba(255, 206, 86, 1)",
          ATM: "rgba(75, 192, 192, 1)",
          Education: "rgba(153, 102, 255, 1)",
          Entertainment: "rgba(255, 159, 64, 1)",
          Travel: "rgba(0, 200, 150, 1)",
          "Nanny Salary": "rgba(100, 149, 237, 1)",
          Other: "rgba(201, 203, 207, 1)",
        };

        // Global variables for exchange rates (in relation to SAR)
        let usdToSar = null,
          eurToSar = null,
          plnToSar = null;

        // Object to hold current sort order for each property
        const sortOrders = {
          date: true,
          category: true,
          description: true,
          amount: true,
        };

        // Get DOM elements
        const form = document.getElementById("expense-form");
        const tableBody = document
          .getElementById("expense-table")
          .getElementsByTagName("tbody")[0];
        const analyzeBtn = document.getElementById("analyze-btn");
        const chartsContainer = document.getElementById("charts-container");
        const chartCanvas = document.getElementById("expense-chart");
        const submitBtn = document.getElementById("submit-btn");
        const expenseCategorySelect =
          document.getElementById("expense-category");
        const newCategoryInput = document.getElementById("new-category");
        const addCategoryBtn = document.getElementById("add-category-btn");
        const filterCategoryContainer = document.getElementById(
          "filter-category-container"
        );
        const calcAmountInput = document.getElementById("calc-amount");
        const calcCurrencySelect = document.getElementById("calc-currency");
        const calcBtn = document.getElementById("calc-btn");
        const calcResultSpan = document.getElementById("calc-result");
        const toggleFilterBtn = document.getElementById("toggle-filter-btn");
        const advancedFilterDiv = document.getElementById("advanced-filter");
        const toggleExpensesBtn = document.getElementById(
          "toggle-expenses-btn"
        );

        // Set current date as default for expense date input
        document.getElementById("expense-date").value = new Date()
          .toISOString()
          .slice(0, 10);

        // Function to update the expense category select options
        function updateCategorySelect() {
          expenseCategorySelect.innerHTML = "";
          const allCategories = defaultCategories.concat(customCategories);
          allCategories.forEach((cat) => {
            const option = document.createElement("option");
            option.value = cat;
            option.textContent = cat;
            expenseCategorySelect.appendChild(option);
          });
        }

        // Function to update the filter checkboxes for categories
        function updateFilterCategories() {
          filterCategoryContainer.innerHTML = "";
          const allCategories = defaultCategories.concat(customCategories);
          allCategories.forEach((cat) => {
            const label = document.createElement("label");
            label.style.marginRight = "8px";
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.name = "filter-category";
            checkbox.value = cat;
            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(" " + cat));
            filterCategoryContainer.appendChild(label);
          });
        }

        // Initialize the category select and filter checkboxes
        updateCategorySelect();
        updateFilterCategories();

        // Function to generate random color for new categories
        function generateRandomColor() {
          const r = Math.floor(Math.random() * 156) + 100;
          const g = Math.floor(Math.random() * 156) + 100;
          const b = Math.floor(Math.random() * 156) + 100;
          return {
            bg: `rgba(${r}, ${g}, ${b}, 0.5)`,
            border: `rgba(${r}, ${g}, ${b}, 1)`,
          };
        }

        // Event listener for adding a new custom category
        addCategoryBtn.addEventListener("click", function () {
          const newCat = newCategoryInput.value.trim();
          if (newCat === "") {
            alert("Please enter a category name.");
            return;
          }
          const allCategories = defaultCategories.concat(customCategories);
          if (allCategories.includes(newCat)) {
            alert("This category already exists.");
            return;
          }
          customCategories.push(newCat);
          const colors = generateRandomColor();
          categoryColors[newCat] = colors.bg;
          categoryBorderColors[newCat] = colors.border;
          updateCategorySelect();
          updateFilterCategories();
          newCategoryInput.value = "";
        });

        // Handle expense form submission
        form.addEventListener("submit", function (e) {
          e.preventDefault();
          const date = document.getElementById("expense-date").value;
          const category = document.getElementById("expense-category").value;
          const description = document.getElementById(
            "expense-description"
          ).value;
          const amount = parseFloat(
            document.getElementById("expense-amount").value
          );
          const indexField = document.getElementById("expense-index").value;

          if (indexField === "") {
            expenses.push({ date, category, description, amount });
          } else {
            expenses[parseInt(indexField)] = {
              date,
              category,
              description,
              amount,
            };
            submitBtn.textContent = "Add Expense";
            document.getElementById("expense-index").value = "";
          }

          updateTable();
          form.reset();
          document.getElementById("expense-date").value = new Date()
            .toISOString()
            .slice(0, 10);
        });

        // Function to populate form for editing an expense
        function editExpense(index) {
          const exp = expenses[index];
          document.getElementById("expense-date").value = exp.date;
          document.getElementById("expense-category").value = exp.category;
          document.getElementById("expense-description").value =
            exp.description;
          document.getElementById("expense-amount").value = exp.amount;
          document.getElementById("expense-index").value = index;
          submitBtn.textContent = "Update Expense";
        }

        // Advanced filter: return filtered expenses based on filter form values
        function filterExpenses() {
          return expenses.filter((exp) => {
            let pass = true;
            const expDate = new Date(exp.date);
            const fromDateVal =
              document.getElementById("filter-from-date").value;
            const toDateVal = document.getElementById("filter-to-date").value;
            if (fromDateVal) {
              const fromDate = new Date(fromDateVal);
              if (expDate < fromDate) pass = false;
            }
            if (toDateVal) {
              const toDate = new Date(toDateVal);
              if (expDate > toDate) pass = false;
            }
            const checkedCategories = Array.from(
              document.querySelectorAll('input[name="filter-category"]:checked')
            ).map((input) => input.value);
            if (
              checkedCategories.length > 0 &&
              !checkedCategories.includes(exp.category)
            ) {
              pass = false;
            }
            const minAmountVal =
              document.getElementById("filter-min-amount").value;
            const maxAmountVal =
              document.getElementById("filter-max-amount").value;
            if (minAmountVal && exp.amount < parseFloat(minAmountVal))
              pass = false;
            if (maxAmountVal && exp.amount > parseFloat(maxAmountVal))
              pass = false;
            return pass;
          });
        }

        // Update the table with filtered expenses and update statistics
        function updateTable() {
          tableBody.innerHTML = "";
          const filteredExpenses = filterExpenses();
          filteredExpenses.forEach((exp) => {
            const row = tableBody.insertRow();
            row.insertCell(0).textContent = exp.date;
            const monthName = new Date(exp.date).toLocaleString("default", {
              month: "long",
              year: "numeric",
            });
            row.insertCell(1).textContent = monthName;
            row.insertCell(2).textContent = exp.category;
            row.insertCell(3).textContent = exp.description;
            row.insertCell(4).textContent = formatAmount(exp.amount) + " SAR";
            const actionCell = row.insertCell(5);
            const editBtn = document.createElement("button");
            editBtn.textContent = "Edit";
            editBtn.className = "edit-btn";
            editBtn.addEventListener("click", function () {
              const originalIndex = expenses.indexOf(exp);
              if (originalIndex !== -1) {
                editExpense(originalIndex);
              }
            });
            actionCell.appendChild(editBtn);
            const removeBtn = document.createElement("button");
            removeBtn.textContent = "Remove";
            removeBtn.className = "remove-btn";
            removeBtn.addEventListener("click", function () {
              const index = expenses.indexOf(exp);
              if (index !== -1) {
                removeExpense(index);
              }
            });
            actionCell.appendChild(removeBtn);
          });
          updateStats();
        }

        function removeExpense(index) {
          expenses.splice(index, 1);
          updateTable();
        }

        function sortExpenses(property, ascending) {
          expenses.sort((a, b) => {
            let valA, valB;
            if (property === "date") {
              valA = new Date(a.date);
              valB = new Date(b.date);
            } else if (property === "amount") {
              valA = a.amount;
              valB = b.amount;
            } else {
              valA = a[property].toLowerCase();
              valB = b[property].toLowerCase();
            }
            if (valA < valB) return ascending ? -1 : 1;
            if (valA > valB) return ascending ? 1 : -1;
            return 0;
          });
        }

        const headers = document.querySelectorAll(
          "#expense-table thead th.sortable"
        );
        headers.forEach((header) => {
          header.addEventListener("click", function () {
            const property = header.getAttribute("data-sort");
            sortOrders[property] = !sortOrders[property];
            sortExpenses(property, sortOrders[property]);
            updateTable();
          });
        });

        // Save expenses and customCategories to a JSON file
        document
          .getElementById("save-btn")
          .addEventListener("click", function () {
            const dataToSave = {
              expenses: expenses,
              customCategories: customCategories,
            };
            const data = JSON.stringify(dataToSave, null, 2);
            const blob = new Blob([data], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "expenses.json";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          });

        // Load expenses and customCategories from a JSON file
        document
          .getElementById("load-file")
          .addEventListener("change", function (e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
              try {
                const data = JSON.parse(e.target.result);
                if (Array.isArray(data)) {
                  expenses = data;
                  customCategories = [];
                } else if (data.expenses && data.customCategories) {
                  expenses = data.expenses;
                  customCategories = data.customCategories;
                } else {
                  alert("Invalid file format.");
                  return;
                }
                updateCategorySelect();
                updateFilterCategories();
                updateTable();
              } catch (err) {
                alert("Error reading file: " + err);
              }
            };
            reader.readAsText(file);
          });

        // Filter form events
        const filterForm = document.getElementById("filter-form");
        filterForm.addEventListener("submit", function (e) {
          e.preventDefault();
          updateTable();
        });
        document
          .getElementById("clear-filter-btn")
          .addEventListener("click", function () {
            document.getElementById("filter-from-date").value = "";
            document.getElementById("filter-to-date").value = "";
            document.getElementById("filter-min-amount").value = "";
            document.getElementById("filter-max-amount").value = "";
            document
              .querySelectorAll('input[name="filter-category"]')
              .forEach((input) => (input.checked = false));
            updateTable();
          });

        // Toggle Advanced Filter section visibility
        toggleFilterBtn.addEventListener("click", function () {
          if (
            advancedFilterDiv.style.display === "none" ||
            advancedFilterDiv.style.display === ""
          ) {
            advancedFilterDiv.style.display = "block";
            toggleFilterBtn.textContent = "Hide Advanced Filter";
          } else {
            advancedFilterDiv.style.display = "none";
            toggleFilterBtn.textContent = "Show Advanced Filter";
          }
        });

        // Toggle Expenses Table visibility using computed style for accurate check on first click
        toggleExpensesBtn.addEventListener("click", function () {
          const tableContainer = document.getElementById(
            "expenses-table-container"
          );
          const currentDisplay =
            window.getComputedStyle(tableContainer).display;
          if (currentDisplay === "none") {
            tableContainer.style.display = "block";
            toggleExpensesBtn.textContent = "Hide Expenses";
          } else {
            tableContainer.style.display = "none";
            toggleExpensesBtn.textContent = "Show Expenses";
          }
        });

        // Update statistics and render statistics charts based on filtered expenses.
        // Arrange statistics text in three horizontal columns.
        function updateStats() {
          const filtered = filterExpenses();
          const statsContainer = document.getElementById("stats-container");
          if (filtered.length === 0) {
            statsContainer.innerHTML =
              "<p>No expenses to calculate statistics.</p>";
            if (monthlyChart) {
              monthlyChart.destroy();
            }
            if (categoryChart) {
              categoryChart.destroy();
            }
            if (monthlyAvgChart) {
              monthlyAvgChart.destroy();
            }
            return;
          }
          const total = filtered.reduce((sum, exp) => sum + exp.amount, 0);
          const count = filtered.length;
          const avg = total / count;
          const uniqueDays = new Set(filtered.map((exp) => exp.date)).size;
          const projectedYearly =
            uniqueDays > 0 ? (365 / uniqueDays) * total : 0;
          const projectedMonthly = projectedYearly / 12;
          const projectedDaily = uniqueDays > 0 ? total / uniqueDays : 0;

          // Build overall statistics text (including Projected Daily Expense)
          const overallStatsHtml = `
          <p><strong>Total Expenses:</strong> SAR ${formatAmount(total)}</p>
          <p><strong>Number of Expenses:</strong> ${count}</p>
          <p><strong>Average Expense (per transaction):</strong> SAR ${formatAmount(
            avg
          )}</p>
          <p><strong>Days Tracked:</strong> ${uniqueDays}</p>
          <p><strong>Projected Daily Expense:</strong> SAR ${formatAmount(
            projectedDaily
          )}</p>
          <p><strong>Projected Monthly Expense:</strong> SAR ${formatAmount(
            projectedMonthly
          )}</p>
          <p><strong>Projected Yearly Expense:</strong> SAR ${formatAmount(
            projectedYearly
          )}</p>
        `;

          // Build By Month list
          let monthListHtml = "<ul>";
          const monthGroups = {};
          filtered.forEach((exp) => {
            const month = new Date(exp.date).toLocaleString("default", {
              month: "long",
              year: "numeric",
            });
            if (!monthGroups[month]) monthGroups[month] = [];
            monthGroups[month].push(exp);
          });
          for (const month in monthGroups) {
            const arr = monthGroups[month];
            const monthTotal = arr.reduce((sum, exp) => sum + exp.amount, 0);
            const monthAvg = monthTotal / arr.length;
            monthListHtml += `<li>${month}: Total = SAR ${formatAmount(
              monthTotal
            )}, Average = SAR ${formatAmount(monthAvg)}</li>`;
          }
          monthListHtml += "</ul>";

          // Build By Category list
          let catListHtml = "<ul>";
          const catGroups = {};
          filtered.forEach((exp) => {
            const cat = exp.category;
            if (!catGroups[cat]) catGroups[cat] = [];
            catGroups[cat].push(exp);
          });
          for (const cat in catGroups) {
            const arr = catGroups[cat];
            const catTotal = arr.reduce((sum, exp) => sum + exp.amount, 0);
            const catAvg = catTotal / arr.length;
            catListHtml += `<li>${cat}: Total = SAR ${formatAmount(
              catTotal
            )}, Average = SAR ${formatAmount(catAvg)}</li>`;
          }
          catListHtml += "</ul>";

          const statsHtml = `
          <div style="flex: 1; padding: 10px;">${overallStatsHtml}</div>
          <div style="flex: 1; padding: 10px;"><h3>By Month</h3>${monthListHtml}</div>
          <div style="flex: 1; padding: 10px;"><h3>By Category</h3>${catListHtml}</div>
        `;
          statsContainer.innerHTML = `<div id="stats-text" style="display: flex; gap: 20px;">${statsHtml}</div>`;

          // --- Render Monthly Totals Bar Chart ---
          let monthLabels = Object.keys(monthGroups);
          monthLabels.sort((a, b) => new Date(a) - new Date(b));
          const monthTotals = monthLabels.map((month) => {
            return monthGroups[month].reduce((sum, exp) => sum + exp.amount, 0);
          });
          if (monthlyChart) {
            monthlyChart.destroy();
          }
          const monthlyCtx = document
            .getElementById("monthly-chart")
            .getContext("2d");
          monthlyChart = new Chart(monthlyCtx, {
            type: "bar",
            data: {
              labels: monthLabels,
              datasets: [
                {
                  label: "Monthly Total (SAR)",
                  data: monthTotals,
                  backgroundColor: "rgba(54, 162, 235, 0.5)",
                  borderColor: "rgba(54, 162, 235, 1)",
                  borderWidth: 1,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                title: {
                  display: true,
                  text: "Total Expenses by Month",
                  color: "#f0f0f0",
                  font: { size: 18 },
                },
                legend: {
                  labels: { color: "#f0f0f0", font: { size: 14 } },
                },
              },
              scales: {
                x: {
                  ticks: { color: "#f0f0f0", font: { size: 12 } },
                  title: {
                    display: true,
                    text: "Month",
                    color: "#f0f0f0",
                    font: { size: 14 },
                  },
                },
                y: {
                  ticks: { color: "#f0f0f0", font: { size: 12 } },
                  title: {
                    display: true,
                    text: "Total Expense (SAR)",
                    color: "#f0f0f0",
                    font: { size: 14 },
                  },
                },
              },
            },
          });

          // --- Render Category Totals Bar Chart ---
          const catLabels = Object.keys(catGroups);
          const catTotals = catLabels.map((cat) => {
            return catGroups[cat].reduce((sum, exp) => sum + exp.amount, 0);
          });
          if (categoryChart) {
            categoryChart.destroy();
          }
          const categoryCtx = document
            .getElementById("category-chart")
            .getContext("2d");
          categoryChart = new Chart(categoryCtx, {
            type: "bar",
            data: {
              labels: catLabels,
              datasets: [
                {
                  label: "Category Total (SAR)",
                  data: catTotals,
                  backgroundColor: catLabels.map(
                    (cat) => categoryColors[cat] || "rgba(0,0,0,0.5)"
                  ),
                  borderColor: catLabels.map(
                    (cat) => categoryBorderColors[cat] || "rgba(0,0,0,0.1)"
                  ),
                  borderWidth: 1,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                title: {
                  display: true,
                  text: "Total Expenses by Category",
                  color: "#f0f0f0",
                  font: { size: 18 },
                },
                legend: {
                  labels: { color: "#f0f0f0", font: { size: 14 } },
                },
              },
              scales: {
                x: {
                  ticks: { color: "#f0f0f0", font: { size: 12 } },
                  title: {
                    display: true,
                    text: "Category",
                    color: "#f0f0f0",
                    font: { size: 14 },
                  },
                },
                y: {
                  ticks: { color: "#f0f0f0", font: { size: 12 } },
                  title: {
                    display: true,
                    text: "Total Expense (SAR)",
                    color: "#f0f0f0",
                    font: { size: 14 },
                  },
                },
              },
            },
          });

          // --- Render Monthly Averages for Each Category Bar Chart ---
          const fixedCategories = Object.keys(categoryColors);
          const monthlyAvgDatasets = fixedCategories.map((cat) => {
            const data = monthLabels.map((month) => {
              const monthExpenses = monthGroups[month].filter(
                (exp) => exp.category === cat
              );
              return monthExpenses.length > 0
                ? monthExpenses.reduce((sum, exp) => sum + exp.amount, 0) /
                    monthExpenses.length
                : 0;
            });
            return {
              label: cat,
              data: data,
              backgroundColor: categoryColors[cat],
              borderColor: categoryBorderColors[cat],
              borderWidth: 1,
            };
          });
          if (monthlyAvgChart) {
            monthlyAvgChart.destroy();
          }
          const monthlyAvgCtx = document
            .getElementById("monthly-avg-chart")
            .getContext("2d");
          monthlyAvgChart = new Chart(monthlyAvgCtx, {
            type: "bar",
            data: {
              labels: monthLabels,
              datasets: monthlyAvgDatasets,
            },
            options: {
              responsive: true,
              plugins: {
                title: {
                  display: true,
                  text: "Monthly Averages by Category (SAR)",
                  color: "#f0f0f0",
                  font: { size: 18 },
                },
                legend: {
                  labels: { color: "#f0f0f0", font: { size: 14 } },
                },
              },
              scales: {
                x: {
                  ticks: { color: "#f0f0f0", font: { size: 12 } },
                  title: {
                    display: true,
                    text: "Month",
                    color: "#f0f0f0",
                    font: { size: 14 },
                  },
                },
                y: {
                  ticks: { color: "#f0f0f0", font: { size: 12 } },
                  title: {
                    display: true,
                    text: "Average Expense (SAR)",
                    color: "#f0f0f0",
                    font: { size: 14 },
                  },
                },
              },
            },
          });
        }

        // Analyze expenses and render charts (for the Analysis section)
        analyzeBtn.addEventListener("click", function () {
          if (expenses.length === 0) {
            alert("No expenses to analyze.");
            return;
          }
          chartsContainer.style.display = "flex";
          const days = Array.from(
            new Set(expenses.map((exp) => exp.date))
          ).sort();
          const categories = Array.from(
            new Set(expenses.map((exp) => exp.category))
          );
          const datasets = categories.map((cat) => {
            const data = days.map((day) => {
              return expenses
                .filter((exp) => exp.date === day && exp.category === cat)
                .reduce((sum, exp) => sum + exp.amount, 0);
            });
            return {
              label: cat,
              data: data,
              backgroundColor: categoryColors[cat] || "rgba(0,0,0,0.5)",
              borderColor: categoryBorderColors[cat] || "rgba(0,0,0,0.1)",
              borderWidth: 1,
            };
          });
          if (expenseChart) {
            expenseChart.destroy();
          }
          expenseChart = new Chart(chartCanvas, {
            type: "bar",
            data: {
              labels: days,
              datasets: datasets,
            },
            options: {
              responsive: true,
              plugins: {
                title: {
                  display: true,
                  text: "Expenses by Day and Category",
                  color: "#f0f0f0",
                  font: { size: 18 },
                },
                legend: {
                  labels: { color: "#f0f0f0", font: { size: 14 } },
                },
              },
              scales: {
                x: {
                  stacked: true,
                  title: {
                    display: true,
                    text: "Date",
                    color: "#f0f0f0",
                    font: { size: 14 },
                  },
                  ticks: { color: "#f0f0f0", font: { size: 12 } },
                },
                y: {
                  stacked: true,
                  title: {
                    display: true,
                    text: "Amount (SAR)",
                    color: "#f0f0f0",
                    font: { size: 14 },
                  },
                  ticks: { color: "#f0f0f0", font: { size: 12 } },
                },
              },
            },
          });

          const pieChartsSection =
            document.getElementById("pie-charts-section");
          pieChartsSection.innerHTML = "";
          const monthGroups = {};
          expenses.forEach((exp) => {
            const monthYear = new Date(exp.date).toLocaleString("default", {
              month: "long",
              year: "numeric",
            });
            if (!monthGroups[monthYear]) {
              monthGroups[monthYear] = [];
            }
            monthGroups[monthYear].push(exp);
          });
          Object.keys(monthGroups).forEach((month) => {
            const categorySums = {};
            monthGroups[month].forEach((exp) => {
              if (!categorySums[exp.category]) {
                categorySums[exp.category] = 0;
              }
              categorySums[exp.category] += exp.amount;
            });
            const pieLabels = Object.keys(categorySums);
            const pieData = pieLabels.map((cat) => categorySums[cat]);
            const pieColors = pieLabels.map(
              (label) => categoryColors[label] || "rgba(0,0,0,0.7)"
            );
            const pieContainer = document.createElement("div");
            const heading = document.createElement("h3");
            heading.textContent = month;
            pieContainer.appendChild(heading);
            const canvas = document.createElement("canvas");
            canvas.style.width = "300px";
            canvas.style.height = "300px";
            pieContainer.appendChild(canvas);
            pieChartsSection.appendChild(pieContainer);
            new Chart(canvas, {
              type: "pie",
              data: {
                labels: pieLabels,
                datasets: [
                  {
                    data: pieData,
                    backgroundColor: pieColors,
                    borderWidth: 1,
                  },
                ],
              },
              options: {
                responsive: true,
                plugins: {
                  title: {
                    display: true,
                    text: "Expense Breakdown for " + month,
                    color: "#f0f0f0",
                    font: { size: 18 },
                  },
                  legend: {
                    labels: { color: "#f0f0f0", font: { size: 14 } },
                  },
                },
              },
            });
          });
        });

        // Fetch exchange rates (using USD as base) and convert to SAR values.
        fetch("https://api.exchangerate-api.com/v4/latest/USD")
          .then((response) => response.json())
          .then((data) => {
            const rates = data.rates;
            if (rates["SAR"] && rates["EUR"] && rates["PLN"]) {
              usdToSar = rates["SAR"]; // 1 USD = rates["SAR"] SAR
              eurToSar = rates["SAR"] / rates["EUR"]; // 1 EUR = (rates["SAR"]/rates["EUR"]) SAR
              plnToSar = rates["SAR"] / rates["PLN"]; // 1 PLN = (rates["SAR"]/rates["PLN"]) SAR
              document.getElementById(
                "exchange-rates"
              ).textContent = `Exchange Rates (to SAR): 1 USD = ${usdToSar.toFixed(
                3
              )} SAR, 1 EUR = ${eurToSar.toFixed(
                3
              )} SAR, 1 PLN = ${plnToSar.toFixed(3)} SAR`;
            } else {
              document.getElementById("exchange-rates").textContent =
                "Exchange rates not available.";
            }
          })
          .catch((error) => {
            document.getElementById("exchange-rates").textContent =
              "Error fetching exchange rates.";
          });

        // Currency Calculator event
        calcBtn.addEventListener("click", function () {
          const amount = parseFloat(calcAmountInput.value);
          const currency = calcCurrencySelect.value;
          if (isNaN(amount)) {
            calcResultSpan.textContent = " Please enter a valid amount.";
            return;
          }
          let result = 0;
          if (currency === "USD") {
            result = amount * usdToSar;
          } else if (currency === "EUR") {
            result = amount * eurToSar;
          } else if (currency === "PLN") {
            result = amount * plnToSar;
          }
          calcResultSpan.textContent = " = SAR " + formatAmount(result);
        });
      });
    </script>
  </body>
</html>
